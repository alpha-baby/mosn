# v0.24.0

# 功能测试

## uds 热升级

可参考集成测试：

https://github.com/mosn/mosn/blob/master/test/integrate/transfer/transfer_test.go#L82

## grpc 热升级

### 编写hello world服务端代码

```Go
package grpc_network_filter

import (
	"context"
	"encoding/json"
	"google.golang.org/grpc"
	hellopb "google.golang.org/grpc/examples/helloworld/helloworld"
	mgrpc "mosn.io/mosn/pkg/filter/network/grpc"
)

func init() {
	mgrpc.RegisterServerHandler("hello", NewHelloExampleGrpcServer)
}

// helloServer is used to implement helloworld.GreeterServer.
type helloServer struct {
	hellopb.UnimplementedGreeterServer
}

// SayHello implements helloworld.GreeterServer
func (s *helloServer) SayHello(ctx context.Context, in *hellopb.HelloRequest) (*hellopb.HelloReply, error) {
	return &hellopb.HelloReply{Message: "Hello " + in.GetName()}, nil
}

func NewHelloExampleGrpcServer(_ json.RawMessage, options ...grpc.ServerOption) (mgrpc.RegisteredServer, error) {
	s := grpc.NewServer(options...)
	hellopb.RegisterGreeterServer(s, &helloServer{})
	return s, nil
}
``` 

### 模拟客户端代码

```Go
func StartClient(mtls bool) {
        go http.ListenAndServe("0.0.0.0:12345", nil)

        pool := x509.NewCertPool()
        pool.AppendCertsFromPEM([]byte(midCa))
        config := &tls.Config{
                RootCAs:    pool,
                ServerName: "127.0.0.1",
        }
        // add tls certificate
        if mtls {
                ca := GetIntermediateCa()
                cert := ca.CreateCertificatePemJson()
                c, err := tls.X509KeyPair([]byte(cert.Cert), []byte(cert.Key))
                if err != nil {
                        panic(err)
                }
                config.Certificates = []tls.Certificate{c}
        }

        connTotal := 20000

        for i := 0; i < connTotal; i++ {
                conn, err := tls.Dial("tcp", "127.0.0.1:2045", config)
                if err != nil {
                        fmt.Println("dial error: ", err)
                        return

                }
                defer conn.Close()
                go func() {
                        conn.SetReadDeadline(time.Time{})
                        if _, err := conn.Write([]byte("test data")); err != nil {
                                fmt.Println("write error: ", err)
                                return
                        }
                        buf := make([]byte, 10)
                        if _, err := conn.Read(buf); err != nil {
                                fmt.Println("read error: ", err)
                                return
                        }
                }()
        }
        fmt.Printf("connected %d conns\n", connTotal)
        // hang up, makes connection exists
        ch := make(chan struct{})
        <-ch

}
```

### 注册server

然后在mosn主函数中导入一下我们写的这个包，让我们写的server注册到mosn grpc network filter框架中

```json
{
  "servers":[
    {
      "default_log_path":"stdout",
      "default_log_level":"INFO",
      "listeners":[
        {
          "address":"127.0.0.1:2045",
          "bind_port": true,
          "filter_chains": [{
            "filters": [
              {
                "type":"grpc",
                "config": {
                  "server_name":"hello"
                }
              }
            ]
          }]
        }
      ]
    }
  ]
}
```

### 启动 mosn

```bash
$  go run ./cmd/mosn/... -c  ./examples/codes/grpc_network/config.json #  
2021-08-04 20:58:05,928 [INFO] register a new handler maker, name is default, is default: true
2021-08-04 20:58:05,929 [INFO] register a grpc server named: hello, success: true
2021-08-04 20:58:05,929 [INFO] [config] processor added to configParsedCBMaps
2021-08-04 20:58:05,934 [INFO] [network] [ register pool factory] register protocol: Http1 factory
2021-08-04 20:58:05,935 [INFO] [network] [ register pool factory] register protocol: Http2 factory
2021-08-04 20:58:05,935 [INFO] [network] [ register pool factory] register protocol: X factory
2021-08-04 20:58:05,937 [INFO] [mosn] [start] xds service type must be sidecar or router
2021-08-04 20:58:05,937 [INFO] load config from :  ./examples/codes/grpc_network/config.json
2021-08-04 20:58:05,938 [INFO] mosn parameters parsed cost: 444.114µs
2021-08-04 20:58:05,938 [INFO] [mosn] [init tracing] disable tracing
2021-08-04 20:58:05,938 [INFO] [mosn start] create a new mosn structure
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn init cluster structures
2021-08-04 20:58:05,939 [WARN] [config] [parse cluster] No Cluster provided in cluster config
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn init server structures
2021-08-04 20:58:05,939 [INFO] parsing listen config:tcp
2021-08-04 20:58:05,939 [WARN] [streamfilter] createStreamFilterFactoryFromConfig return nil factories
2021-08-04 20:58:05,939 [INFO] [streamfilter] AddOrUpdateStreamFilterConfig add filter chain key: c23a1fe8-47e1-4f64-8896-0394e5ed2c45
2021-08-04 20:58:05,939 [INFO] [server] [conn handler] [add listener] add listener: 127.0.0.1:2045
2021-08-04 20:58:05,939 [INFO] mosn init cost: 1.449957ms
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn start xds client
2021-08-04 20:58:05,939 [WARN] [feature gate] feature XdsMtlsEnable is not enabled
2021-08-04 20:58:05,939 [WARN] [feature gate] feature PayLoadLimitEnable is not enabled
2021-08-04 20:58:05,939 [WARN] [feature gate] feature MultiTenantMode is not enabled
2021-08-04 20:58:05,939 [WARN] [feature gate] feature auto_config is not enabled
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn parse extend config
2021-08-04 20:58:05,939 [INFO] mosn prepare to start cost: 11.396µs
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn transfer connections
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn clean upgrade datas
2021-08-04 20:58:05,939 [INFO] [mosn start] mosn start server
2021-08-04 20:58:05,939 [WARN] no admin config, no admin api served
2021-08-04 20:58:05,939 [INFO] [admin store] [mosn state] state changed to 1
2021-08-04 20:58:05,939 [INFO] xds client start
2021-08-04 20:58:05,939 [ERROR] StaticResources is null
2021-08-04 20:58:05,939 [WARN] fail to init xds config, skip xds: null point exception
2021-08-04 20:58:05,939 [INFO] mosn start cost: 11.207µs
2021-08-04 20:58:06,941 [INFO] [server] [reconfigure] reconfigureHandler start
```

### 编写grpc客户端

参考grpc-go官方代码：https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_client/main.go

```go
package main

import (
	"context"
	"fmt"
	"log"
	"time"

	"google.golang.org/grpc"
	pb "google.golang.org/grpc/examples/helloworld/helloworld"
)

const (
	address     = "127.0.0.1:2045"
)

func main() {
	for TaskID:=0;TaskID<100;TaskID++{
		go func(id int) {
			conn, err := grpc.Dial(address, grpc.WithInsecure())
			if err != nil {
				log.Fatal(err)
			}
			cli := pb.NewGreeterClient(conn)
			data := 0
			for {
				data += 1
				Task(id, cli, fmt.Sprintf("%d", data))
			}
		}(TaskID)
	}

	time.Sleep(time.Minute * 30)
}

func Task(taskID int, cli pb.GreeterClient, data string) {
	ctx, cancel := context.WithCancel(context.TODO())
	defer cancel()

	_, err := cli.SayHello(
		ctx,
		&pb.HelloRequest{Name: data},
	)
	if err != nil {
		log.Fatal(err)
	}
	time.Sleep(time.Millisecond * 10)
}
```

###启动客户端

```bash
$ go run main.go
```

### 触发热升级

```bash
$ kill -HUP [mosn pid]
```

## 路由配置新增变量配置模式

参考单元测试：

https://github.com/mosn/mosn/blob/master/pkg/router/base_rule_test.go#L963

## 路由virtualhost匹配支持端口匹配模式

参考单元测试：

https://github.com/mosn/mosn/blob/master/pkg/router/routers_impl_test.go#L350

## envoy header_to_metadata filter

### 编写两个http server

```go
// server1
package main

import (
	"fmt"
	"net/http"
)

func ServeHTTP(w http.ResponseWriter, r *http.Request) {
	response := fmt.Sprintf("country: %v\n", "china")
	w.Write([]byte(response))
}

func main() {
	http.HandleFunc("/", ServeHTTP)
	http.ListenAndServe("127.0.0.1:10001", nil)
}
```

```go
// server2
package main

import (
	"fmt"
	"net/http"
)

func ServeHTTP(w http.ResponseWriter, r *http.Request) {
	response := fmt.Sprintf("city: %v\n", "hangzhou")
	w.Write([]byte(response))
}

func main() {
	http.HandleFunc("/", ServeHTTP)
	http.ListenAndServe("127.0.0.1:10002", nil)
}
```

### 启动两个http server

```bash
$ go run ./examples/codes/http-sample/server1.go
$ go run ./examples/codes/http-sample/server2.go
```

### 启动mosn

配置文件:

```json
{
	"servers": [
		{
			"routers": [
				{
					"router_config_name": "server_router",
					"virtual_hosts": [
						{
							"name": "serverHost",
							"domains": [
								"*"
							],
							"routers": [
								{
									"route": {
										"cluster_name": "serverCluster"
									}
								}
							]
						}
					]
				}
			],
			"listeners": [
				{
					"name": "example",
					"address": "0.0.0.0:9999",
					"bind_port": true,
					"filter_chains": [
						{
							"filters": [
								{
									"type": "proxy",
									"config": {
										"downstream_protocol": "Http1",
										"upstream_protocol": "Http1",
										"router_config_name": "server_router"
									}
								}
							]
						}
					],
					"stream_filters": [
						{
							"type": "header_to_metadata",
							"config": {
								"request_rules": [
									{
										"header": "x-country",
										"on_header_present": {
											"key": "country"
										},
										"remove": true
									},
									{
										"header": "x-city",
										"on_header_present": {
											"key": "city"
										}
									}
								]
							}
						}
					]
				}
			]
		}
	],
	"cluster_manager": {
		"clusters": [
			{
				"name": "serverCluster",
				"type": "SIMPLE",
				"lb_type": "LB_ROUNDROBIN",
				"max_request_per_conn": 1024,
				"conn_buffer_limit_bytes": 32768,
				"hosts": [
					{
						"address": "127.0.0.1:10001",
						"metadata": {
							"filter_metadata": {
								"mosn.lb": {
									"country": "china"
								}
							}
						},
						"weight": 100
					},
					{
						"address": "127.0.0.1:10002",
						"metadata": {
							"filter_metadata": {
								"mosn.lb": {
									"city": "hangzhou"
								}
							}
						},
						"weight": 100
					}
				],
				"lb_subset_config": {
					"fall_back_policy": 1,
					"subset_selectors": [
						[
							"country"
						],
						[
							"city"
						]
					]
				}
			}
		]
	}
}
```

```bash
$ go run ./cmd/mosn/... -c  ./examples/codes/client_config.json
```

### 请求测试

```bash
$ curl -v "http://127.0.0.1:9999/haha" -H "x-city:hangzhou"
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 9999 (#0)
> GET /haha HTTP/1.1
> Host: 127.0.0.1:9999
> User-Agent: curl/7.64.1
> Accept: */*
> x-city:hangzhou
>
< HTTP/1.1 200 OK
< Date: Wed, 04 Aug 2021 15:07:16 GMT
< Content-Type: text/plain; charset=utf-8
< Content-Length: 15
<
city: hangzhou
* Connection #0 to hos
```

```bash
$ curl -v "http://127.0.0.1:9999/haha" -H "x-country:china"
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 9999 (#0)
> GET /haha HTTP/1.1
> Host: 127.0.0.1:9999
> User-Agent: curl/7.64.1
> Accept: */*
> x-country:china
>
< HTTP/1.1 200 OK
< Date: Wed, 04 Aug 2021 15:07:51 GMT
< Content-Type: text/plain; charset=utf-8
< Content-Length: 15
<
country: china
* Connection #0 to ho
```